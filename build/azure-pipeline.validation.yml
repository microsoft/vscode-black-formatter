# PR and Push validation pipeline

trigger:
  branches:
    include:
      - main
      - release
      - release/*
      - release-*

pr:
  branches:
    include:
      - main
      - release
      - release/*
      - release-*
  drafts: false

resources:
  repositories:
    - repository: MicroBuildTemplate
      type: git
      name: 1ESPipelineTemplates/MicroBuildTemplate
      ref: refs/tags/release

    - repository: templates
      type: git
      name: DevDiv/Pylance-Eng
      ref: refs/heads/main
variables:
  - name: TeamName
    value: VSCode-black-formatter
  - name: VsixName
    value: black-formatter.vsix
  - name: AZURE_ARTIFACTS_FEED
    value: 'https://devdiv.pkgs.visualstudio.com/DevDiv/_packaging/Pylance_PublicPackages/npm/registry/'

parameters:
  - name: buildSteps
    type: stepList
    default:
      - script: npm ci
        displayName: Install NPM dependencies

      - script: python -m pip install -U pip
        displayName: Upgrade pip

      - script: python -m pip install wheel
        displayName: Install wheel

      - script: python -m pip install nox
        displayName: Install nox

      - script: python -m nox --session install_bundled_libs
        displayName: Install Python dependencies

      - script: npm run package
        displayName: Build extension

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    sdl:
      enabled: false
    pool:
      name: AzurePipelines-EO
      os: windows

    customBuildTags:
      - ES365AIMigrationTooling
    stages:
      - stage: Build
        displayName: Build & Package Extension
        jobs:
          - template: azure-pipelines/extension/templates/jobs/package.yml@templates
            parameters:
              buildSteps: ${{ parameters.buildSteps }}
              isPreRelease: false
              standardizedVersioning: true
              customNPMRegistry: $(AZURE_ARTIFACTS_FEED)
