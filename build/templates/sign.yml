# Template: Sign and validate VS Code extension artifacts
# Usage Example:
# - template: build/templates/sign.yml@self
#   parameters:
#     vsixName: black-formatter.vsix
#     workingDirectory: $(Build.SourcesDirectory)
#     signType: real
parameters:
  - name: vsixName
    type: string
    default: autopep8.vsix
  - name: manifestName
    type: string
    default: extension.manifest
  - name: signatureName
    type: string
    default: extension.signature.p7s
  - name: workingDirectory
    type: string
    default: '$(Build.SourcesDirectory)'
  - name: signType
    type: string
    default: real
  - name: verifySignature
    type: boolean
    default: true
  - name: prepareRoot
    type: boolean
    default: true
  - name: teamName
    type: string
    default: VSCode-autopep8

steps:
  - task: NuGetToolInstaller@1
    displayName: Install NuGet

  - task: NuGetCommand@2
    displayName: Restore signing packages
    inputs:
      command: restore
      feedsToUse: config
      restoreSolution: '$(Build.SourcesDirectory)/packages.config'
      restoreDirectory: '$(Build.SourcesDirectory)/packages'
      nugetConfigPath: '$(Build.SourcesDirectory)/build/NuGet.config'

  - powershell: |
      New-Item -ItemType Directory -Path "$(Build.StagingDirectory)\drop" -Force | Out-Null; Copy-Item "$(Build.SourcesDirectory)\$(VsixName)" "$(Build.StagingDirectory)\drop\$(VsixName)" -Force; if (!(Test-Path "$(Build.StagingDirectory)\drop\$(VsixName)")) { Write-Error 'VSIX copy failed'; exit 1 }; Get-Item "$(Build.StagingDirectory)\drop\$(VsixName)" | Format-Table Name,Length,LastWriteTime -AutoSize
    displayName: Copy VSIX into drop

  - script: npx vsce generate-manifest -i "$(Build.StagingDirectory)\drop\$(VsixName)" -o "$(Build.StagingDirectory)\drop\extension.manifest"
    displayName: Generate extension manifest

  - task: PowerShell@2
    displayName: Pre-sign inspection
    inputs:
      targetType: inline
      script: |
        $wd = "${{ parameters.workingDirectory }}"
        $vsixName = "${{ parameters.vsixName }}"
        $manifestName = "${{ parameters.manifestName }}"
        $signatureName = "${{ parameters.signatureName }}"
        Write-Host "Pre-sign contents of working directory: $wd"
        Get-ChildItem -Recurse $wd | Select-Object FullName,Length | Format-Table -AutoSize
        $vsix = Join-Path $wd $vsixName
        if (!(Test-Path $vsix)) { Write-Error "VSIX missing: $vsix"; exit 1 }
        $manifest = Join-Path $wd $manifestName
        if (!(Test-Path $manifest)) { Write-Error "Manifest missing: $manifest"; exit 1 }
        $sig = Join-Path $wd $signatureName
        if (!(Test-Path $sig)) { Write-Warning "Signature placeholder missing (will attempt signing anyway)." }

  # ✅ Added MicroBuildSigningPlugin for PME enforcement
  - task: MicroBuildSigningPlugin@4
    displayName: Enable MicroBuild Signing
    inputs:
      signType: ${{ parameters.signType }} # 'real' or 'test'
      zipSources: false
      feedSource: 'https://devdiv.pkgs.visualstudio.com/DefaultCollection/_packaging/MicroBuildToolset/nuget/v3/index.json'
      ConnectedServiceName: 'MicroBuild Signing Task (DevDiv)'
      ConnectedPMEServiceName: 6cc74545-d7b9-4050-9dfa-ebefcc8961ea
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      TeamName: ${{ parameters.teamName }}

  - task: MSBuild@1
    displayName: Run signing (MSBuild)
    inputs:
      solution: '$(Build.SourcesDirectory)/build/sign.proj'
      msbuildArguments: >
        /verbosity:detailed
        /bl:"${{ parameters.workingDirectory }}\\signing.binlog"
        /p:SignType=${{ parameters.signType }}
        /p:BaseOutputDirectory=${{ parameters.workingDirectory }}
        /p:OutDir=${{ parameters.workingDirectory }}
        /p:IntermediateOutputPath=${{ parameters.workingDirectory }}\\intermediate

  - task: PowerShell@2
    displayName: Post-sign inspection
    inputs:
      targetType: inline
      script: |
        $wd = "${{ parameters.workingDirectory }}"
        $signatureName = "${{ parameters.signatureName }}"
        Write-Host "Post-sign file listing:"
        Get-ChildItem $wd -File | Select-Object Name,Length | Format-Table -AutoSize
        $sig = Join-Path $wd $signatureName
        if (Test-Path $sig) {
          Write-Host "Signature file present: $sig"
        } else {
          Write-Warning "Signature file NOT present after signing step."; exit 0
        }

  - task: PowerShell@2
    displayName: Validate signature differs from manifest (hash check)
    inputs:
      targetType: inline
      script: |
        $wd = "${{ parameters.workingDirectory }}"
        $manifest = Join-Path $wd "${{ parameters.manifestName }}"
        $signature = Join-Path $wd "${{ parameters.signatureName }}"
        if (!(Test-Path $manifest)) { Write-Error "Manifest missing for hash comparison: $manifest"; exit 1 }
        if (!(Test-Path $signature)) { Write-Error "Signature missing for hash comparison: $signature"; exit 1 }
        $manifestHash = (Get-FileHash -Algorithm SHA256 $manifest).Hash
        $signatureHash = (Get-FileHash -Algorithm SHA256 $signature).Hash
        Write-Host "Manifest SHA256 : $manifestHash"
        Write-Host "Signature SHA256: $signatureHash"
        if ($manifestHash -eq $signatureHash) {
          Write-Error "Signature file is identical to manifest (placeholder detected). Failing build."; exit 1
        } else {
          Write-Host "Hashes differ ✅ (signature not a direct copy of manifest)"
        }

  - ${{ if eq(parameters.verifySignature, true) }}:
      - task: PowerShell@2
        displayName: Verify VSIX signature
        inputs:
          targetType: inline
          script: |
            $wd = "${{ parameters.workingDirectory }}"
            $vsix       = Join-Path $wd "${{ parameters.vsixName }}"
            $manifest   = Join-Path $wd "${{ parameters.manifestName }}"
            $signature  = Join-Path $wd "${{ parameters.signatureName }}"
            Write-Host "Verifying signature:"
            Write-Host "  packagePath  : $vsix"
            Write-Host "  manifestPath : $manifest"
            Write-Host "  signaturePath: $signature"
            if (!(Test-Path $vsix)) { Write-Error "Missing VSIX: $vsix"; exit 1 }
            if (!(Test-Path $manifest)) { Write-Error "Missing manifest: $manifest"; exit 1 }
            if (!(Test-Path $signature)) { Write-Error "Missing signature file: $signature"; exit 1 }
            npx @vscode/vsce verify-signature --packagePath "$vsix" --manifestPath "$manifest" --signaturePath "$signature"
            if ($LASTEXITCODE -ne 0) {
              Write-Error "vsce verify-signature failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            } else {
              Write-Host "vsce verify-signature succeeded ✅"
            }
